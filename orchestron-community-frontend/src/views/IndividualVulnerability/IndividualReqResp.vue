<template>
    <div>
      <b-container fluid>
        <ReqRespHeader :reqResHeaderData="reqResHeaderData"></ReqRespHeader>
        <br>
        <request-and-response :reqRespData="reqRespData" :request="request" :response="response" :log="log"></request-and-response>
      </b-container>
    </div>
</template>

<script>
    import ReqRespHeader from '@/components/RequestAndResponse/Header'
    import RequestAndResponse from '@/components/RequestAndResponse/RequestAndResponse'
    import axios from '@/utils/auth'
    import { notValidUser } from '@/utils/checkAuthUser'

    export default {
      name: 'IndividualReqResp',
      components: {
        ReqRespHeader,
        RequestAndResponse
      },
      data() {
        return {
          reqRespData: [],
          request: false,
          response: false,
          log: false,
          reqResHeaderData: []
        }
      },
      created() {
        this.org = localStorage.getItem('org')
        this.token = localStorage.getItem('token')
        this.appName = this.$route.params.appName
        this.vulName = this.$route.params.vulName
        this.cwe = this.$route.params.cwe
        this.url = this.$route.params.url
        this.param = this.$route.params.param
        this.fetchData()
      },
      methods: {
        fetchData() {
          if (this.org && this.token) {
            axios.get('/openvul/' + this.appName + '/' + this.vulName + '/' + this.cwe + '/' + this.url + '/')
              .then(res => {
                for (const val of Object.values(res.data)) {
                  this.reqResHeaderData.push({
                    appName: val.app_name,
                    appUrl: val.app_url,
                    cwe: val.cwe,
                    owasp: val.owasp,
                    tool: val.tool,
                    scanName: val.scan_short_name,
                    sanId: val.scan_id,
                    url: this.url,
                    param: this.param
                  })
                  if (val.request) {
                    axios.get(val.request)
                      .then(res => {
                        this.reqRespData.push({
                          request: res.data
                        })
                        this.request = true
                      }).catch(error => {
                        if (error.res.status === 404) {
                          this.$router.push('/not_found')
                        } else if (error.res.status === 403) {
                          this.$router.push('/forbidden')
                        } else {
                          this.$router.push('/error')
                        }
                      })
                  }
                  if (val.response) {
                    axios.get(val.response)
                      .then(res => {
                        this.reqRespData.push({
                          response: res.data
                        })
                        this.response = true
                      }).catch(error => {
                        if (error.res.status === 404) {
                          this.$router.push('/not_found')
                        } else if (error.res.status === 403) {
                          this.$router.push('/forbidden')
                        } else {
                          this.$router.push('/error')
                        }
                      })
                  }
                  if (val.log) {
                    axios.get(val.log)
                      .then(res => {
                        this.reqRespData.push({
                          log: res.data
                        })
                        this.log = true
                      }).catch(error => {
                        if (error.res.status === 404) {
                          this.$router.push('/not_found')
                        } else if (error.res.status === 403) {
                          this.$router.push('/forbidden')
                        } else {
                          this.$router.push('/error')
                        }
                      })
                  }
                }
              }).catch(error => {
                if (error.res.status === 404) {
                  this.$router.push('/not_found')
                } else if (error.res.status === 403) {
                  this.$router.push('/forbidden')
                } else {
                  this.$router.push('/error')
                }
              })
          }
        }
      }
    }
</script>

<style scoped>

</style>
